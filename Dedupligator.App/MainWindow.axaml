<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:Dedupligator.App.ViewModels"
        xmlns:views="clr-namespace:Dedupligator.App.Views"
        xmlns:controls="clr-namespace:Dedupligator.App.Controls"
        xmlns:behaviors="clr-namespace:Dedupligator.App.Infrastructure.Behaviors"
        xmlns:iconPacks="clr-namespace:IconPacks.Avalonia.Lucide;assembly=IconPacks.Avalonia.Lucide"
        mc:Ignorable="d"
        d:DesignWidth="1000"
        d:DesignHeight="600"
        x:Class="Dedupligator.App.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="Dedupligator - Duplicate Finder"
        MinHeight="600" MinWidth="900"
        WindowStartupLocation="CenterScreen"
        FontFamily="Segoe UI, Inter, system-ui"
        Icon="/Assets/avalonia-logo.ico">

  <Design.DataContext>
    <vm:MainWindowViewModel/>
  </Design.DataContext>

  <Window.Styles>
    <!-- Стиль для Window -->
    <Style Selector="Window">
      <Setter Property="Background" Value="{DynamicResource SemiGrey0Color}"/>
    </Style>

    <Style Selector="controls|SimpleIconButton.ModernButtonStyle">
      <Setter Property="Height" Value="36"/>
      <Setter Property="Theme" Value="{DynamicResource SolidButton}"/>
    </Style>

    <Style Selector="controls|SimpleIconButton.DangerButtonStyle">
      <Setter Property="Height" Value="36"/>
      <Setter Property="Theme" Value="{DynamicResource SolidButton}"/>
      <Setter Property="ButtonClass" Value="Danger"/>
    </Style>

    <Style Selector="Border.CommonBorderStyle">
      <Setter Property="Theme" Value="{DynamicResource CardBorder}"/>
      <Setter Property="Padding" Value="8"/>
    </Style>
  </Window.Styles>
  
 <Grid RowDefinitions="*,Auto" Margin="8">
    <!-- Основное содержимое -->
    <Grid Grid.Row="0">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="*"/>
      </Grid.RowDefinitions>

      <!-- Панель управления -->
      <Border Grid.Row="0"
              Classes="CommonBorderStyle"
              Margin="0 0 0 8">
        <StackPanel Spacing="8">
          <Grid ColumnDefinitions="*,Auto" VerticalAlignment="Center">
            <TextBox Name="PathPreMessageTextBox" IsReadOnly="True"
                     Padding="6"
                     Height="36"
                     Text="Выберите папку для сканирования..."
                     IsVisible="{Binding SelectedFolderPath, 
                      Converter={x:Static ObjectConverters.IsNull}}"/>
            <TextBox Name="PathTextBox" IsReadOnly="True"
                     Padding="6"
                     Height="36"
                     Text="{Binding SelectedFolderPath}"
                     IsVisible="{Binding SelectedFolderPath, 
                      Converter={x:Static ObjectConverters.IsNotNull}}"/>

            <controls:SimpleIconButton Grid.Column="1" Margin="8 0 0 0" Width="100"
                              Text="Обзор..."
                              Icon="{iconPacks:Lucide FolderOpen, Width=18, Height=18}"
                              Click="BrowseButton_Click"
                              Classes="ModernButtonStyle"/>
          </Grid>

          <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Spacing="8">
            <controls:SimpleIconButton Text="Сканировать"
                                       Icon="{iconPacks:Lucide Search, Width=18, Height=18}"
                                       Command="{Binding ScanFolderCommand}"
                                       Classes="ModernButtonStyle"/>

            <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Spacing="8">
              <RadioButton GroupName="First Group" Content="Точное совпадение"
                         IsChecked="{Binding UseExactMatch}"/>
              <RadioButton GroupName="First Group" Content="Похожие"/>
            </StackPanel>

            <ProgressBar Name="ProgressBar" Width="300" Height="20"
                       IsVisible="{Binding IsProcess}"
                       ShowProgressText="True"
                       Value="{Binding Progress}"/>
          </StackPanel>
        </StackPanel>
      </Border>

      <!-- Основная область -->
      <Grid Grid.Row="1" Margin="0">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="300" MinWidth="200"/>
          <ColumnDefinition Width="8"/>
          <ColumnDefinition Width="*" MinWidth="300"/>
        </Grid.ColumnDefinitions>

        <GridSplitter Grid.Column="1" ShowsPreview="False" Width="3"/>

        <!-- Левая панель - группы -->
        <Border Grid.Column="0" 
                Margin="0 0 2 0"
                Classes="CommonBorderStyle">
          <Grid RowDefinitions="Auto, 8, *">
            <TextBlock Text="Группы дубликатов" FontSize="16" FontWeight="SemiBold"
                       Foreground="{DynamicResource TextPrimaryColor}" Margin="0 0 0 8" Grid.Row="0"/>

            <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
              <ListBox Name="GroupsListBox" SelectionMode="Single"
                       ItemsSource="{Binding DuplicateGroups}"
                       SelectedItem="{Binding SelectedFileGroup}"
                       Background="Transparent"
                       BorderThickness="0">
                <ListBox.ItemTemplate>
                  <DataTemplate>
                    <StackPanel Spacing="4">
                      <TextBlock Text="{Binding GroupName}" FontWeight="SemiBold" FontSize="14" Foreground="{DynamicResource TextPrimaryColor}"/>
                      <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="Файлов: " FontSize="12" Foreground="{DynamicResource TextSecondaryColor}"/>
                        <TextBlock Text="{Binding FileCount}" FontSize="12" Foreground="{DynamicResource TextSecondaryColor}" FontWeight="SemiBold"/>
                      </StackPanel>
                      <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="Размер: " FontSize="12" Foreground="{DynamicResource TextSecondaryColor}"/>
                        <TextBlock Text="{Binding TotalSize}" FontSize="12" Foreground="{DynamicResource TextSecondaryColor}" FontWeight="SemiBold"/>
                      </StackPanel>
                    </StackPanel>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>
            </ScrollViewer>
          </Grid>
        </Border>

        <!-- Правая панель - превью -->
        <Border Grid.Column="2" 
                Margin="2 0 0 0"
                Classes="CommonBorderStyle"
                Padding="0">

          <Grid Margin="0">
            <!-- Полноэкранное изображение -->
            <Border Background="{DynamicResource SemiGrey1Color}"
                    IsVisible="{Binding SelectedImage, Converter={x:Static ObjectConverters.IsNotNull}}"
                    CornerRadius="6"
                    ZIndex="100">
              <Grid RowDefinitions="*,Auto" ColumnDefinitions="*,Auto">
                <Image Grid.Row="0" Grid.Column="0" Grid.RowSpan="2" Grid.ColumnSpan="2"
                       Source="{Binding SelectedImage}"
                       Stretch="Uniform"
                       Margin="0"/>

                <Button Grid.Row="0" Grid.Column="1"
                        HorizontalAlignment="Right" VerticalAlignment="Top"
                        Margin="8" Width="32" Height="32" CornerRadius="16"
                        Padding="0"
                        HorizontalContentAlignment="Center"
                        VerticalContentAlignment="Center"
                        Background="{DynamicResource DangerColor}"
                        Command="{Binding CloseFullScreenCommand}"
                        Content="✕"/>
              </Grid>
            </Border>

            <!-- Обычный режим с сеткой превью -->
            <Grid RowDefinitions="*,Auto"
                  Margin="0"
                  IsVisible="{Binding SelectedImage, Converter={x:Static ObjectConverters.IsNull}}">
              <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto" Padding="8">
                <ItemsControl Name="PreviewItemsControl"
                              ItemsSource="{Binding FilePreviews}"
                              Margin="0">
                  <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                      <WrapPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                  </ItemsControl.ItemsPanel>

                  <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type vm:ImagePreviewViewModel}">
                      <views:ImagePreviewView Margin="0 0 4 4"
                        behaviors:DoubleClickBehavior.Command="{Binding $parent[ItemsControl].DataContext.OpenFullScreenCommand}"
                        behaviors:DoubleClickBehavior.CommandParameter="{Binding}"/>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
              </ScrollViewer>

              <controls:SimpleIconButton Grid.Row="1" Margin="0 0 0 0"
                                         HorizontalAlignment="Right" Text="Удалить отмеченные"
                                         Icon="{iconPacks:Lucide Trash2, Width=18, Height=18}"
                                         Command="{Binding RemoveFilesCommand}"
                                         Classes="DangerButtonStyle"/>
            </Grid>
          </Grid>
        </Border>
      </Grid>
    </Grid>

    <!-- Панель статуса -->
    <Border Grid.Row="1" Name="StatusBarBorder" Margin="0 8 0 0"
            Height="36"
            Classes="CommonBorderStyle"
            Background="{DynamicResource SemiGrey1Color}">
      <Grid ColumnDefinitions="*,Auto">
        <StackPanel Orientation="Horizontal" Grid.Column="0" Spacing="8" VerticalAlignment="Center">
          <StackPanel Orientation="Horizontal" Spacing="4">
            <TextBlock Text="Файлов:" FontSize="12" Foreground="{DynamicResource TextSecondaryColor}" FontWeight="Medium"/>
            <TextBlock Text="{Binding TotalFiles}" FontSize="12" Foreground="{DynamicResource TextSecondaryColor}" FontWeight="SemiBold"/>
          </StackPanel>

          <Rectangle Width="1" Height="16" Fill="{DynamicResource BorderColor}"/>

          <StackPanel Orientation="Horizontal" Spacing="4">
            <TextBlock Text="Групп:" FontSize="12" Foreground="{DynamicResource TextSecondaryColor}" FontWeight="Medium"/>
            <TextBlock Text="{Binding TotalGroup}" FontSize="12" Foreground="{DynamicResource TextSecondaryColor}" FontWeight="SemiBold"/>
          </StackPanel>
        </StackPanel>

        <TextBlock Name="VersionTextBlock" Text="{Binding AppVersion}" FontSize="12" Foreground="{DynamicResource TextSecondaryColor}"
                   Grid.Column="1" VerticalAlignment="Center"/>
      </Grid>
    </Border>
  </Grid>
</Window>